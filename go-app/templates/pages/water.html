{{define "water.html"}}
<div class="space-y-6">
    <h2 class="text-2xl font-bold">Water Management</h2>

    <div class="flex gap-4 items-end flex-wrap">
        <div class="form-control">
            <label class="label"><span class="label-text">Select Lawn</span></label>
            <select onchange="window.location='/water?lawn='+this.value" class="select select-bordered">
                <option value="">Choose a lawn...</option>
                {{range .Lawns}}
                <option value="{{.ID}}" {{if and $.SelectedID (eq .ID (deref $.SelectedID))}}selected{{end}}>{{.Name}}</option>
                {{end}}
            </select>
        </div>
        {{if .SelectedID}}
        <button onclick="document.getElementById('irrig-form').classList.toggle('hidden')" class="btn btn-info btn-sm">+ Log Irrigation</button>
        {{end}}
    </div>

    {{if .SelectedID}}
    <div id="irrig-form" class="hidden card bg-base-100 shadow-sm">
        <div class="card-body">
            <h3 class="card-title">Log Irrigation</h3>
            <form hx-post="/irrigation" hx-swap="none" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="hidden" name="lawn_id" value="{{deref .SelectedID}}">
                <div class="form-control">
                    <label class="label"><span class="label-text">Date</span></label>
                    <input name="date" type="date" required class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Amount (inches)</span></label>
                    <input name="amount" type="number" step="0.01" required class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Duration (min)</span></label>
                    <input name="duration" type="number" value="0" class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Source</span></label>
                    <select name="source" class="select select-bordered">
                        <option value="MANUAL">Manual</option>
                        <option value="AUTOMATIC">Automatic</option>
                        <option value="SCHEDULED">Scheduled</option>
                    </select>
                </div>
                <div class="md:col-span-4">
                    <button type="submit" class="btn btn-info">Log Irrigation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Water Chart -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <h3 class="card-title">Weekly Water Balance</h3>
            <canvas id="water-chart" height="200"></canvas>
        </div>
    </div>

    <!-- Weekly Summaries -->
    {{if .Summaries}}
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th class="text-right">ET0</th>
                            <th class="text-right">Precip</th>
                            <th class="text-right">Irrigation</th>
                            <th class="text-right">Deficit</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Summaries}}
                        <tr>
                            <td>{{formatDate .WeekStart}} - {{formatDate .WeekEnd}}</td>
                            <td class="text-right">{{formatFloat .ET0Total 2}}"</td>
                            <td class="text-right">{{formatFloat .PrecipitationTotal 2}}"</td>
                            <td class="text-right">{{formatFloat .IrrigationApplied 2}}"</td>
                            <td class="text-right">{{formatFloat .WaterDeficit 2}}"</td>
                            <td>{{statusBadge .Status}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{end}}

    <!-- Irrigation Entries -->
    {{if .Irrigation}}
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <h3 class="card-title text-lg">Irrigation Entries</h3>
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Date</th><th class="text-right">Amount</th><th>Duration</th><th>Source</th><th></th></tr>
                    </thead>
                    <tbody>
                        {{range .Irrigation}}
                        <tr>
                            <td>{{formatDate .Date}}</td>
                            <td class="text-right">{{formatFloat .Amount 2}}"</td>
                            <td>{{.Duration}} min</td>
                            <td><span class="badge badge-outline badge-sm">{{.Source}}</span></td>
                            <td><button hx-delete="/irrigation/{{.ID}}" hx-confirm="Delete this entry?" class="btn btn-ghost btn-xs text-error">Delete</button></td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{end}}
    {{end}}
</div>

{{if .SelectedID}}
<script>
fetch('/api/water-summary/{{deref .SelectedID}}')
    .then(r => r.json()).then(data => {
        if (!data || !data.length) return;
        data.reverse();
        new Chart(document.getElementById('water-chart'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.week_start.substring(5,10)),
                datasets: [
                    {label:'ET0',data:data.map(d=>d.et0_total),backgroundColor:'rgba(239,68,68,0.6)'},
                    {label:'Precip',data:data.map(d=>d.precipitation_total),backgroundColor:'rgba(59,130,246,0.6)'},
                    {label:'Irrigation',data:data.map(d=>d.irrigation_applied),backgroundColor:'rgba(34,197,94,0.6)'}
                ]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    });
</script>
{{end}}
{{end}}
