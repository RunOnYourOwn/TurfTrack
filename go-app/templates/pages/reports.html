{{define "reports.html"}}
<div class="space-y-6">
    <h2 class="text-2xl font-bold">Reports</h2>

    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <h3 class="card-title text-lg">Nutrient Applications Over Time</h3>
            <canvas id="reports-chart" height="250"></canvas>
        </div>
    </div>

    {{if .Applications}}
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Product</th>
                            <th class="text-right">N (lbs)</th>
                            <th class="text-right">P (lbs)</th>
                            <th class="text-right">K (lbs)</th>
                            <th class="text-right">Fe (lbs)</th>
                            <th class="text-right">Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Applications}}
                        <tr>
                            <td>{{formatDate .ApplicationDate}}</td>
                            <td>{{$prod := index $.ProductMap .ProductID}}{{if $prod}}{{$prod.Name}}{{end}}</td>
                            <td class="text-right">{{formatFloatPtr .NApplied 3}}</td>
                            <td class="text-right">{{formatFloatPtr .PApplied 3}}</td>
                            <td class="text-right">{{formatFloatPtr .KApplied 3}}</td>
                            <td class="text-right">{{formatFloatPtr .FeApplied 3}}</td>
                            <td class="text-right">{{formatFloatPtr .CostApplied 2}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{else}}
    <div class="alert">
        <span>No application data to report. Log applications first.</span>
    </div>
    {{end}}
</div>

<script>
(function() {
    const apps = {{json .Applications}};
    if (!apps || !apps.length) return;
    const labels = apps.map(a => a.application_date.substring(0,10));
    new Chart(document.getElementById('reports-chart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {label:'N',data:apps.map(a=>a.n_applied||0),backgroundColor:'rgba(34,197,94,0.7)'},
                {label:'P',data:apps.map(a=>a.p_applied||0),backgroundColor:'rgba(59,130,246,0.7)'},
                {label:'K',data:apps.map(a=>a.k_applied||0),backgroundColor:'rgba(168,85,247,0.7)'},
                {label:'Fe',data:apps.map(a=>a.fe_applied||0),backgroundColor:'rgba(245,158,11,0.7)'}
            ]
        },
        options: {responsive:true,plugins:{legend:{position:'bottom'}},scales:{x:{stacked:true},y:{stacked:true}}}
    });
})();
</script>
{{end}}
