{{define "gdd.html"}}
<div class="space-y-6">
    <h2 class="text-2xl font-bold">Growing Degree Days</h2>

    <div class="flex gap-4 items-end flex-wrap">
        <div class="form-control">
            <label class="label"><span class="label-text">Location</span></label>
            <select id="gdd-loc" onchange="window.location='/gdd?location_id='+this.value" class="select select-bordered">
                <option value="">Select location...</option>
                {{range .Locations}}
                <option value="{{.ID}}" {{if and $.SelectedLocationID (eq .ID (deref $.SelectedLocationID))}}selected{{end}}>{{.Name}}</option>
                {{end}}
            </select>
        </div>
    </div>

    {{if .SelectedLocationID}}
    <!-- Add GDD Model Form (collapse) -->
    <div class="collapse collapse-arrow bg-base-100 shadow-sm">
        <input type="checkbox" />
        <div class="collapse-title font-semibold">+ Add GDD Model</div>
        <div class="collapse-content">
            <form hx-post="/gdd-models" hx-swap="none" hx-indicator="#gdd-loading" class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                <input type="hidden" name="location_id" value="{{deref .SelectedLocationID}}">
                <div class="form-control">
                    <label class="label"><span class="label-text">Name</span></label>
                    <input name="name" required class="input input-bordered" placeholder="e.g. Crabgrass Preventer">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Base Temp</span></label>
                    <input name="base_temp" type="number" step="0.1" required class="input input-bordered" value="50">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Unit</span></label>
                    <select name="unit" class="select select-bordered">
                        <option value="F">Fahrenheit</option>
                        <option value="C">Celsius</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Start Date</span></label>
                    <input name="start_date" type="date" required class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Threshold</span></label>
                    <input name="threshold" type="number" step="0.1" value="0" class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input name="reset_on_threshold" type="checkbox" class="checkbox checkbox-primary">
                        <span class="label-text">Reset on Threshold</span>
                    </label>
                </div>
                <div class="md:col-span-3 flex items-center gap-3">
                    <button type="submit" class="btn btn-primary">Create Model</button>
                    <span id="gdd-loading" class="loading loading-spinner loading-sm htmx-indicator"></span>
                </div>
            </form>
        </div>
    </div>

    {{range .GDDModels}}
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="card-title">{{.Name}}</h3>
                    <p class="text-sm text-base-content/60">Base: {{formatFloat .BaseTemp 1}}{{.Unit}} | Start: {{formatDate .StartDate}} | Threshold: {{formatFloat .Threshold 0}}</p>
                </div>
                <button class="btn btn-ghost btn-xs text-error" onclick="confirmDelete('/gdd-models/{{.ID}}', 'Delete GDD model \'{{.Name}}\'?')">Delete</button>
            </div>
            <div id="gdd-chart-{{.ID}}"></div>
        </div>
    </div>
    <script>
    (function() {
        var themeMode = document.documentElement.getAttribute('data-theme') === 'emerald' ? 'light' : 'dark';
        var fmtGDD = function(v) { return v != null ? parseFloat(v).toFixed(1) : ''; };
        fetch('/api/gdd-values/{{.ID}}')
            .then(r => r.json()).then(data => {
                if (!data || !data.length) return;
                var chart = new ApexCharts(document.getElementById('gdd-chart-{{.ID}}'), {
                    chart: {type:'area',height:250,toolbar:{show:true,tools:{download:true,zoom:true,pan:true,reset:true}},background:'transparent'},
                    theme: {mode: themeMode},
                    dataLabels: {enabled:false},
                    series: [{name:'Cumulative GDD',data:data.map(d=>({x:d.date.substring(5,10),y:parseFloat(d.cumulative_gdd.toFixed(1))}))}],
                    colors: ['#22c55e'],
                    fill: {type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.4,opacityTo:0.1}},
                    stroke: {curve:'smooth',width:2},
                    xaxis: {type:'category',labels:{rotate:-45,rotateAlways:false,hideOverlappingLabels:true},tickAmount:10},
                    yaxis: {title:{text:'GDD'},labels:{formatter:fmtGDD}},
                    legend: {position:'bottom'},
                    tooltip: {shared:true,intersect:false,y:{formatter:fmtGDD}}
                });
                chart.render();
            });
    })();
    </script>
    {{end}}

    {{if not .GDDModels}}
    <div class="alert alert-info">
        <span>No GDD models for this location. Create one above.</span>
    </div>
    {{end}}
    {{end}}
</div>
{{end}}
