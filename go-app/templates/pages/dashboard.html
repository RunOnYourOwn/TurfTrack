{{define "dashboard.html"}}
<div class="space-y-6">
    <h2 class="text-2xl font-bold">Dashboard</h2>

    {{if .Locations}}
    <div class="form-control w-full max-w-xs">
        <label class="label"><span class="label-text">Select Location</span></label>
        <select id="location-select" onchange="loadDashboard(this.value)" class="select select-bordered">
            <option value="">Choose a location...</option>
            {{range .Locations}}
            <option value="{{.ID}}">{{.Name}} ({{formatFloat .Latitude 4}}, {{formatFloat .Longitude 4}})</option>
            {{end}}
        </select>
    </div>

    <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-lg">Temperature</h3>
                <div id="temp-chart"></div>
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-lg">Disease Pressure</h3>
                <div id="disease-chart"></div>
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-lg">Growth Potential</h3>
                <div id="gp-chart"></div>
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-lg">Weed Pressure</h3>
                <div id="weed-chart"></div>
            </div>
        </div>
    </div>
    {{else}}
    <div class="alert alert-info">
        <span>No locations yet. Add a lawn to get started.</span>
    </div>
    {{end}}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-lg">Lawns</h3>
                {{if .Lawns}}
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead><tr><th>Name</th><th>Area</th><th>Type</th><th>Location</th></tr></thead>
                        <tbody>
                        {{range .Lawns}}
                        <tr><td>{{.Name}}</td><td>{{formatFloat .Area 0}} sq ft</td><td>{{.GrassType}}</td><td>{{if .Location}}{{.Location.Name}}{{end}}</td></tr>
                        {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}<p class="text-base-content/60">No lawns yet.</p>{{end}}
            </div>
        </div>
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body">
                <h3 class="card-title text-lg">Locations</h3>
                {{if .Locations}}
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead><tr><th>Name</th><th>Latitude</th><th>Longitude</th></tr></thead>
                        <tbody>
                        {{range .Locations}}
                        <tr><td>{{.Name}}</td><td>{{formatFloat .Latitude 4}}</td><td>{{formatFloat .Longitude 4}}</td></tr>
                        {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}<p class="text-base-content/60">No locations yet.</p>{{end}}
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};
function loadDashboard(locationID) {
    if (!locationID) return;
    fetch('/api/weather/' + locationID + '?start_date=' + daysAgo(30))
        .then(r => r.json()).then(data => {
            if (!data) return;
            renderChart('temp-chart', {
                chart: {type:'line',height:250,toolbar:{show:false},background:'transparent'},
                theme: {mode: document.documentElement.getAttribute('data-theme') === 'emerald' ? 'light' : 'dark'},
                series: [
                    {name:'Max',data:data.map(d=>({x:d.date.substring(0,10),y:d.temperature_max_f}))},
                    {name:'Min',data:data.map(d=>({x:d.date.substring(0,10),y:d.temperature_min_f}))}
                ],
                colors: ['#ef4444','#3b82f6'],
                stroke: {curve:'smooth',width:2},
                xaxis: {type:'category',labels:{rotate:-45,rotateAlways:false}},
                yaxis: {title:{text:'\u00b0F'}},
                legend: {position:'bottom'},
                tooltip: {shared:true,intersect:false}
            });
        });
    fetch('/api/disease/' + locationID + '?start_date=' + daysAgo(30))
        .then(r => r.json()).then(data => {
            if (!data) return;
            renderChart('disease-chart', {
                chart: {type:'area',height:250,toolbar:{show:false},background:'transparent'},
                theme: {mode: document.documentElement.getAttribute('data-theme') === 'emerald' ? 'light' : 'dark'},
                series: [{name:'Risk Score',data:data.map(d=>({x:d.date.substring(0,10),y:d.risk_score}))}],
                colors: ['#f59e0b'],
                fill: {type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.4,opacityTo:0.1}},
                stroke: {curve:'smooth',width:2},
                xaxis: {type:'category'},
                legend: {position:'bottom'},
                tooltip: {shared:true,intersect:false}
            });
        });
    fetch('/api/growth-potential/' + locationID + '?start_date=' + daysAgo(30))
        .then(r => r.json()).then(data => {
            if (!data) return;
            renderChart('gp-chart', {
                chart: {type:'area',height:250,toolbar:{show:false},background:'transparent'},
                theme: {mode: document.documentElement.getAttribute('data-theme') === 'emerald' ? 'light' : 'dark'},
                series: [{name:'Growth Potential',data:data.map(d=>({x:d.date.substring(0,10),y:d.growth_potential}))}],
                colors: ['#22c55e'],
                fill: {type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.4,opacityTo:0.1}},
                stroke: {curve:'smooth',width:2},
                xaxis: {type:'category'},
                legend: {position:'bottom'},
                tooltip: {shared:true,intersect:false}
            });
        });
    fetch('/api/weed-pressure/' + locationID + '?start_date=' + daysAgo(30))
        .then(r => r.json()).then(data => {
            if (!data) return;
            renderChart('weed-chart', {
                chart: {type:'area',height:250,toolbar:{show:false},background:'transparent'},
                theme: {mode: document.documentElement.getAttribute('data-theme') === 'emerald' ? 'light' : 'dark'},
                series: [{name:'Weed Pressure',data:data.map(d=>({x:d.date.substring(0,10),y:d.weed_pressure_score}))}],
                colors: ['#a855f7'],
                fill: {type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.4,opacityTo:0.1}},
                stroke: {curve:'smooth',width:2},
                xaxis: {type:'category'},
                legend: {position:'bottom'},
                tooltip: {shared:true,intersect:false}
            });
        });
}
function daysAgo(n) {
    const d = new Date(); d.setDate(d.getDate()-n); return d.toISOString().substring(0,10);
}
function renderChart(id, options) {
    if (charts[id]) charts[id].destroy();
    var el = document.getElementById(id);
    el.innerHTML = '';
    charts[id] = new ApexCharts(el, options);
    charts[id].render();
}
</script>
{{end}}
