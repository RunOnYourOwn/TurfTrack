{{define "dashboard.html"}}
<div class="space-y-6">
    <h2 class="text-2xl font-bold">Dashboard</h2>

    {{if .Locations}}
    <div class="mb-4">
        <label class="block text-sm font-medium mb-1">Select Location</label>
        <select id="location-select" onchange="loadDashboard(this.value)" class="border rounded-lg px-3 py-2 bg-white dark:bg-gray-800 dark:border-gray-600">
            <option value="">Choose a location...</option>
            {{range .Locations}}
            <option value="{{.ID}}">{{.Name}} ({{formatFloat .Latitude 4}}, {{formatFloat .Longitude 4}})</option>
            {{end}}
        </select>
    </div>

    <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Charts load here via JavaScript -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Temperature</h3>
            <canvas id="temp-chart" height="200"></canvas>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Disease Pressure (Smith-Kerns)</h3>
            <canvas id="disease-chart" height="200"></canvas>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Growth Potential</h3>
            <canvas id="growth-chart" height="200"></canvas>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-2">Water Status</h3>
            <div id="water-cards" class="space-y-2">
                <p class="text-gray-500 text-sm">Select a location to view water data</p>
            </div>
        </div>
    </div>
    {{else}}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 text-center">
        <p class="text-gray-500">No locations yet. <a href="/lawns" class="text-green-600 hover:underline">Add a lawn</a> to get started.</p>
    </div>
    {{end}}
</div>

<script>
let tempChart, diseaseChart, growthChart;

function loadDashboard(locationId) {
    if (!locationId) return;

    fetch('/api/weather/' + locationId + '?start_date=' + daysAgo(14) + '&end_date=' + daysAhead(16))
        .then(r => r.json())
        .then(data => {
            if (!data) return;
            const labels = data.map(d => d.date.substring(0, 10));
            const maxTemps = data.map(d => d.temperature_max_f);
            const minTemps = data.map(d => d.temperature_min_f);
            updateChart('temp-chart', tempChart, c => tempChart = c, labels, [
                {label: 'Max Temp (F)', data: maxTemps, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true},
                {label: 'Min Temp (F)', data: minTemps, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true}
            ]);
        });

    fetch('/api/disease/' + locationId)
        .then(r => r.json())
        .then(data => {
            if (!data) return;
            const labels = data.map(d => d.date.substring(0, 10));
            const scores = data.map(d => d.risk_score ? (d.risk_score * 100).toFixed(1) : null);
            updateChart('disease-chart', diseaseChart, c => diseaseChart = c, labels, [
                {label: 'Risk %', data: scores, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true}
            ]);
        });

    fetch('/api/growth-potential/' + locationId)
        .then(r => r.json())
        .then(data => {
            if (!data) return;
            const labels = data.map(d => d.date.substring(0, 10));
            const gp = data.map(d => d.growth_potential ? (d.growth_potential * 100).toFixed(1) : null);
            const gp7 = data.map(d => d.gp_7d_avg ? (d.gp_7d_avg * 100).toFixed(1) : null);
            updateChart('growth-chart', growthChart, c => growthChart = c, labels, [
                {label: 'Daily GP %', data: gp, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true},
                {label: '7-day Avg %', data: gp7, borderColor: '#16a34a', borderDash: [5,5]}
            ]);
        });
}

function updateChart(canvasId, existing, setter, labels, datasets) {
    if (existing) existing.destroy();
    const ctx = document.getElementById(canvasId).getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {labels, datasets},
        options: {
            responsive: true,
            plugins: {legend: {position: 'top'}},
            scales: {x: {display: true, ticks: {maxTicksLimit: 10}}}
        }
    });
    setter(chart);
}

function daysAgo(n) {
    const d = new Date(); d.setDate(d.getDate() - n);
    return d.toISOString().substring(0, 10);
}
function daysAhead(n) {
    const d = new Date(); d.setDate(d.getDate() + n);
    return d.toISOString().substring(0, 10);
}
</script>
{{end}}
