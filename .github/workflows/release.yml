name: Release

on:
  push:
    tags:
      - "v*.*.*"

# Cancel in-progress runs when a new tag is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  # Run Go tests before building release
  test:
    name: Test Release Candidate
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: turftrack
          POSTGRES_PASSWORD: turftrack
          POSTGRES_DB: turftrack_test
        ports:
          - 5432:5432
        options: --health-cmd="pg_isready -U turftrack -d turftrack_test" --health-interval=5s --health-timeout=5s --health-retries=5
    env:
      TEST_DATABASE_URL: "host=localhost port=5432 user=turftrack password=turftrack dbname=turftrack_test sslmode=disable"
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Run Go unit tests
        working-directory: go-app
        run: |
          go test ./... -race -count=1 -v

      - name: Run integration tests
        working-directory: go-app
        run: |
          go test ./... -tags integration -race -count=1 -v

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Build Docker image for release
  build:
    name: Build Docker Image
    needs: test
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.image-names.outputs.image-tag }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image names
        id: image-names
        run: |
          # Convert to lowercase for Docker compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="${{ env.REGISTRY }}/${REPO_LOWER}:${{ github.sha }}"
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Build image (local for testing)
        uses: docker/build-push-action@v5
        with:
          context: ./go-app
          file: ./go-app/Dockerfile
          platforms: linux/amd64
          load: true
          tags: turftrack:ci

      - name: Save image artifact
        run: docker save turftrack:ci -o turftrack-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: turftrack-image
          path: turftrack-image.tar

      - name: Clean up Docker resources
        if: always()
        run: docker system prune -f --volumes

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Test built container
  test-container:
    name: Test Built Container
    needs: build
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: turftrack
          POSTGRES_PASSWORD: turftrack
          POSTGRES_DB: turftrack_test
        ports:
          - 5432:5432
        options: --health-cmd="pg_isready -U turftrack -d turftrack_test" --health-interval=5s --health-timeout=5s --health-retries=5
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: turftrack-image

      - name: Load image
        run: docker load -i turftrack-image.tar

      - name: Test container
        run: |
          docker run -d --name test-turftrack --network host \
            -e DATABASE_URL="host=localhost port=5432 user=turftrack password=turftrack dbname=turftrack_test sslmode=disable" \
            turftrack:ci

          echo "Waiting for application to start..."
          sleep 10

          echo "Container logs:"
          docker logs test-turftrack || true

          echo "Running health check..."
          curl -v http://localhost:8080/health || echo "Health endpoint not available yet"

          echo "Testing version endpoint..."
          curl -v http://localhost:8080/api/v1/version || echo "Version endpoint not available"

          echo "Final container logs:"
          docker logs test-turftrack || true

          docker stop test-turftrack
          docker rm test-turftrack

      - name: Security scan with Trivy
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.58.0

          echo "Scanning TurfTrack image for vulnerabilities..."
          trivy image --severity HIGH,CRITICAL turftrack:ci || echo "Vulnerabilities found in image"

      - name: Clean up Docker resources
        if: always()
        run: docker system prune -f --volumes

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Publish multi-arch image to GHCR
  publish:
    name: Publish Docker Image
    needs: test-container
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version from tag
        id: extract-version
        run: |
          VERSION=${{ github.ref_name }}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        with:
          context: ./go-app
          file: ./go-app/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/runonyourown/turftrack:latest
            ghcr.io/runonyourown/turftrack:${{ steps.extract-version.outputs.version }}

      - name: Clean up Docker resources
        if: always()
        run: docker system prune -f --volumes

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Create draft GitHub release
  release:
    name: Create Draft Release
    needs: publish
    runs-on: [self-hosted, Linux]
    permissions:
      contents: write
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --draft \
            --generate-notes \
            --title "Release ${{ github.ref_name }}" \
            --notes "Docker Image: \`ghcr.io/runonyourown/turftrack:${{ github.ref_name }}\`"

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*
