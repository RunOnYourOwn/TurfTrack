name: Release

on:
  push:
    tags:
      - "v*.*.*"

# Cancel in-progress runs when a new tag is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  # Run Go tests before building release
  test:
    name: Test Release Candidate
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: turftrack
          POSTGRES_PASSWORD: turftrack
          POSTGRES_DB: turftrack_test
        ports:
          - 5432:5432
        options: --health-cmd="pg_isready -U turftrack -d turftrack_test" --health-interval=5s --health-timeout=5s --health-retries=5
    env:
      TEST_DATABASE_URL: "host=localhost port=5432 user=turftrack password=turftrack dbname=turftrack_test sslmode=disable"
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: false

      - name: Run Go unit tests
        working-directory: go-app
        run: |
          go test ./... -race -count=1 -v

      - name: Run integration tests
        working-directory: go-app
        run: |
          go test ./... -tags integration -race -count=1 -v

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Build Docker image for release
  build:
    name: Build Docker Image
    needs: test
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.image-names.outputs.image-tag }}
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate image names
        id: image-names
        run: |
          # Convert to lowercase for Docker compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_TAG="${{ env.REGISTRY }}/${REPO_LOWER}:${{ github.sha }}"
          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Build image (local for testing)
        uses: docker/build-push-action@v5
        with:
          context: ./go-app
          file: ./go-app/Dockerfile
          platforms: linux/amd64
          load: true
          tags: turftrack:ci

      - name: Save image artifact
        run: docker save turftrack:ci -o turftrack-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: turftrack-image
          path: turftrack-image.tar

      - name: Clean up Docker resources
        if: always()
        run: docker system prune -f --volumes

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Test built container
  test-container:
    name: Test Built Container
    needs: build
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: turftrack
          POSTGRES_PASSWORD: turftrack
          POSTGRES_DB: turftrack_test
        ports:
          - 5432:5432
        options: --health-cmd="pg_isready -U turftrack -d turftrack_test" --health-interval=5s --health-timeout=5s --health-retries=5
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: turftrack-image

      - name: Load image
        run: docker load -i turftrack-image.tar

      - name: Start container
        run: |
          docker run -d --name test-turftrack --network host \
            -e DATABASE_URL="host=localhost port=5432 user=turftrack password=turftrack dbname=turftrack_test sslmode=disable" \
            turftrack:ci

      - name: Wait for healthy
        run: |
          echo "Polling /health (up to 30s)..."
          for i in $(seq 1 15); do
            STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/health 2>/dev/null || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed on attempt $i"
              break
            fi
            echo "Attempt $i: status=$STATUS, retrying in 2s..."
            sleep 2
          done
          if [ "$STATUS" != "200" ]; then
            echo "=== Container logs ==="
            docker logs test-turftrack || true
            echo "Health check failed after 30s"
            exit 1
          fi

      - name: Verify DB connectivity
        run: |
          BODY=$(curl -sf http://localhost:8080/health)
          echo "Health response: $BODY"
          echo "$BODY" | grep -q '"status":"healthy"' || {
            echo "Health endpoint did not return healthy status"
            exit 1
          }

      - name: Verify version endpoint
        run: |
          BODY=$(curl -sf http://localhost:8080/api/v1/version)
          echo "Version response: $BODY"
          # Verify version field exists and is non-empty
          echo "$BODY" | grep -q '"version"' || {
            echo "Version endpoint missing version field"
            exit 1
          }

      - name: Stop container
        if: always()
        run: |
          docker stop test-turftrack || true
          docker rm test-turftrack || true

      - name: Security scan with Trivy
        run: |
          # Install Trivy
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.58.0

          echo "Scanning TurfTrack image for vulnerabilities..."
          trivy image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 1 turftrack:ci

      - name: Clean up Docker resources
        if: always()
        run: docker system prune -f --volumes

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Publish multi-arch image to GHCR
  publish:
    name: Publish Docker Image
    needs: test-container
    runs-on: [self-hosted, Linux]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version from tag
        id: extract-version
        run: |
          VERSION=${{ github.ref_name }}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Verify tag matches app version
        run: |
          TAG_VERSION="${{ github.ref_name }}"
          # Strip leading 'v' from tag for comparison
          TAG_NUM="${TAG_VERSION#v}"
          # Read version from CHANGELOG (first version heading)
          CHANGELOG_VERSION=$(grep -m1 -oP '(?<=\[)\d+\.\d+\.\d+(?=\])' CHANGELOG.md || true)
          echo "Tag version: $TAG_NUM"
          echo "CHANGELOG version: $CHANGELOG_VERSION"
          if [ -n "$CHANGELOG_VERSION" ] && [ "$TAG_NUM" != "$CHANGELOG_VERSION" ]; then
            echo "ERROR: Tag $TAG_VERSION does not match CHANGELOG version $CHANGELOG_VERSION"
            echo "Run ./scripts/version.sh release before tagging"
            exit 1
          fi

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        with:
          context: ./go-app
          file: ./go-app/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/runonyourown/turftrack:latest
            ghcr.io/runonyourown/turftrack:${{ steps.extract-version.outputs.version }}

      - name: Clean up Docker resources
        if: always()
        run: docker system prune -f --volumes

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*

  # Create draft GitHub release
  release:
    name: Create Draft Release
    needs: publish
    runs-on: [self-hosted, Linux]
    permissions:
      contents: write
    steps:
      - name: Pre-checkout cleanup
        run: |
          echo "Cleaning workspace before checkout..."
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.git || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract CHANGELOG entry
        id: changelog
        run: |
          TAG_VERSION="${{ github.ref_name }}"
          TAG_NUM="${TAG_VERSION#v}"
          # Extract the section for this version from CHANGELOG.md
          # Matches from "## [X.Y.Z]" to the next "## [" or end of file
          NOTES=$(awk "/^## \\[${TAG_NUM}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="No changelog entry found for ${TAG_VERSION}."
          fi
          # Write to file to preserve formatting
          echo "$NOTES" > /tmp/changelog-entry.md

      - name: Build release notes
        run: |
          CHANGELOG=$(cat /tmp/changelog-entry.md)
          {
            echo '## Docker Image'
            echo ''
            echo '```'
            echo 'docker pull ghcr.io/runonyourown/turftrack:${{ github.ref_name }}'
            echo '```'
            echo ''
            echo '## What'\''s Changed'
            echo ''
            echo "$CHANGELOG"
          } > /tmp/release-notes.md

      - name: Create Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --draft \
            --title "Release ${{ github.ref_name }}" \
            --notes-file /tmp/release-notes.md

      - name: Cleanup workspace
        if: always()
        run: rm -rf $GITHUB_WORKSPACE/*
